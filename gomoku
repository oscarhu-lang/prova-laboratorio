import arcade

BOARD_SIZE = 15


class GomokuGame(arcade.Window):
    def __init__(self):
        super().__init__(600, 600, "Wuziqi")

        self.margin = 50
        self.cell_size = (self.width - 2 * self.margin) / (BOARD_SIZE - 1)

        self.board_state = {}  # (riga, colonna) -> "nero" / "bianco"
        self.current_player = "nero"
        self.game_over = False

        arcade.set_background_color(arcade.color.BISQUE)

        self.player_label = None
        self.winner_label = None

    def setup(self):
        self.update_player_label()

    def on_draw(self):
        self.clear()

        # Griglia
        for i in range(BOARD_SIZE):
            y = self.margin + i * self.cell_size
            arcade.draw_line(self.margin, y, self.width - self.margin, y, arcade.color.BLACK, 2)

            x = self.margin + i * self.cell_size
            arcade.draw_line(x, self.margin, x, self.height - self.margin, arcade.color.BLACK, 2)

        # Punti stella
        for r in [3, 7, 11]:
            for c in [3, 7, 11]:
                x, y = self.coordinate_to_pixel(r, c)
                arcade.draw_circle_filled(x, y, 5, arcade.color.BLACK)

        # Disegno delle pietre (QUI Ãˆ LA PARTE CHIAVE)
        for (riga, colonna), giocatore in self.board_state.items():
            x, y = self.coordinate_to_pixel(riga, colonna)

            colore = arcade.color.BLACK if giocatore == "nero" else arcade.color.WHITE
            bordo = arcade.color.BLACK

            raggio = self.cell_size * 0.4

            arcade.draw_circle_filled(x, y, raggio, colore)
            arcade.draw_circle_outline(x, y, raggio, bordo, 2)

        # Bordo esterno
        arcade.draw_lbwh_rectangle_outline(
            self.margin,
            self.margin,
            self.width - 2 * self.margin,
            self.height - 2 * self.margin,
            arcade.color.BLACK,
            3
        )

        if self.player_label:
            self.player_label.draw()
        if self.winner_label:
            self.winner_label.draw()

    def on_mouse_press(self, x, y, button, modifiers):
        if self.game_over:
            return

        riga, colonna = self.get_intersezione_vicina(x, y)

        if riga is None or (riga, colonna) in self.board_state:
            return

        self.board_state[(riga, colonna)] = self.current_player

        if self.controlla_vittoria(riga, colonna):
            self.game_over = True
            vincitore = "Nero" if self.current_player == "nero" else "Bianco"
            self.winner_label = arcade.Text(
                f"{vincitore} Vince!",
                self.width // 2,
                self.height - 30,
                arcade.color.RED,
                28,
                anchor_x="center",
                bold=True
            )
            self.player_label = arcade.Text(
                "Clicca per ricominciare",
                self.width // 2,
                40,
                arcade.color.DARK_BLUE,
                16,
                anchor_x="center"
            )
        else:
            self.current_player = "bianco" if self.current_player == "nero" else "nero"
            self.update_player_label()

    def on_mouse_release(self, x, y, button, modifiers):
        if self.game_over:
            self.reset_game()

    def update_player_label(self):
        nome = "Nero" if self.current_player == "nero" else "Bianco"
        self.player_label = arcade.Text(
            f"Giocatore Corrente: {nome}",
            self.width // 2,
            20,
            arcade.color.BLACK,
            18,
            anchor_x="center"
        )

    def coordinate_to_pixel(self, riga, colonna):
        return (
            self.margin + colonna * self.cell_size,
            self.margin + riga * self.cell_size
        )

    def get_intersezione_vicina(self, x, y):
        colonna = round((x - self.margin) / self.cell_size)
        riga = round((y - self.margin) / self.cell_size)

        if 0 <= riga < BOARD_SIZE and 0 <= colonna < BOARD_SIZE:
            return riga, colonna
        return None, None

    def controlla_vittoria(self, riga, colonna):
        giocatore = self.board_state[(riga, colonna)]

        direzioni = [
            [(0, 1), (0, -1)],
            [(1, 0), (-1, 0)],
            [(1, 1), (-1, -1)],
            [(1, -1), (-1, 1)]
        ]

        for coppia in direzioni:
            conteggio = 1
            for dx, dy in coppia:
                rr, cc = riga, colonna
                while True:
                    rr += dx
                    cc += dy
                    if (
                        0 <= rr < BOARD_SIZE and
                        0 <= cc < BOARD_SIZE and
                        self.board_state.get((rr, cc)) == giocatore
                    ):
                        conteggio += 1
                    else:
                        break
            if conteggio >= 5:
                return True

        return False

    def reset_game(self):
        self.board_state.clear()
        self.current_player = "nero"
        self.game_over = False
        self.winner_label = None
        self.update_player_label()


if __name__ == "__main__":
    gioco = GomokuGame()
    gioco.setup()
    arcade.run()
